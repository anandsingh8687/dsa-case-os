<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- CACHE BUSTING: Force browser to reload - v2.0.0-20260211 -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>DSA Case OS ‚Äî Credit Decision Intelligence</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { sans: ['Inter', 'sans-serif'] },
      colors: {
        brand: { 50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e40af',900:'#1e3a5f' },
      }
    }
  }
}
</script>
<style>
[x-cloak]{display:none!important}
.fade-in{animation:fadeIn .3s ease-in-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.pulse-dot{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#f1f5f9}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
.glass{background:rgba(255,255,255,0.85);backdrop-filter:blur(12px)}
</style>
</head>
<body class="bg-gray-50 font-sans" x-data="app()" x-init="init()">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div x-show="toast.show" x-transition x-cloak
     class="fixed top-4 right-4 z-50 px-5 py-3 rounded-xl shadow-lg text-white text-sm font-medium"
     :class="toast.type==='success'?'bg-emerald-500':'bg-red-500'">
  <span x-text="toast.msg"></span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<template x-if="!token">
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-brand-900 via-brand-800 to-blue-900">
  <div class="w-full max-w-md fade-in">
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-white/10 rounded-2xl mb-4">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
      </div>
      <h1 class="text-3xl font-bold text-white">DSA Case OS</h1>
      <p class="text-blue-200 mt-2">Credit Decision Intelligence Platform</p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-8">
      <div class="flex bg-gray-100 rounded-lg p-1 mb-6">
        <button @click="authMode='login'" :class="authMode==='login'?'bg-white shadow text-brand-700':'text-gray-500'" class="flex-1 py-2 rounded-md text-sm font-semibold transition-all">Sign In</button>
        <button @click="authMode='register'" :class="authMode==='register'?'bg-white shadow text-brand-700':'text-gray-500'" class="flex-1 py-2 rounded-md text-sm font-semibold transition-all">Register</button>
      </div>

      <template x-if="authMode==='register'">
        <div class="space-y-4 fade-in">
          <input x-model="reg.full_name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none" placeholder="Full Name">
          <input x-model="reg.email" type="email" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none" placeholder="Email">
          <input x-model="reg.phone" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none" placeholder="Phone (optional)">
          <input x-model="reg.password" type="password" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none" placeholder="Password">
          <button @click="doRegister()" :disabled="loading" class="w-full py-3 bg-brand-600 text-white font-semibold rounded-xl hover:bg-brand-700 transition-colors disabled:opacity-50">
            <span x-show="!loading">Create Account</span><span x-show="loading">Creating...</span>
          </button>
        </div>
      </template>

      <template x-if="authMode==='login'">
        <div class="space-y-4 fade-in">
          <input x-model="login.email" type="email" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none" placeholder="Email">
          <input x-model="login.password" type="password" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none" placeholder="Password" @keyup.enter="doLogin()">
          <button @click="doLogin()" :disabled="loading" class="w-full py-3 bg-brand-600 text-white font-semibold rounded-xl hover:bg-brand-700 transition-colors disabled:opacity-50">
            <span x-show="!loading">Sign In</span><span x-show="loading">Signing in...</span>
          </button>
        </div>
      </template>
    </div>
    <p class="text-center text-blue-300 text-xs mt-6">Powered by DSA Case OS v1.0</p>
  </div>
</div>
</template>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<template x-if="token">
<div class="min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-brand-900 text-white flex flex-col fixed h-full z-40">
    <div class="p-5 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-white/10 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </div>
        <div>
          <div class="font-bold text-sm">DSA Case OS</div>
          <div class="text-[10px] text-blue-300">Credit Intelligence</div>
        </div>
      </div>
    </div>
    <nav class="flex-1 p-3 space-y-1">
      <button @click="page='dashboard'" :class="page==='dashboard'?'bg-white/15 text-white':'text-blue-200 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
        Dashboard
      </button>
      <button @click="page='newcase'" :class="page==='newcase'?'bg-white/15 text-white':'text-blue-200 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        New Case
      </button>
      <button @click="page='copilot'" :class="page==='copilot'?'bg-white/15 text-white':'text-blue-200 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
        Lender Copilot
      </button>
      <button @click="page='bankanalyzer'" :class="page==='bankanalyzer'?'bg-white/15 text-white':'text-blue-200 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Bank Statement Analyzer
      </button>
    </nav>
    <div class="p-4 border-t border-white/10">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-brand-600 rounded-full flex items-center justify-center text-xs font-bold" x-text="user?.full_name?.charAt(0)||'U'"></div>
        <div class="flex-1 min-w-0">
          <div class="text-xs font-medium truncate" x-text="user?.full_name||'User'"></div>
          <div class="text-[10px] text-blue-300 truncate" x-text="user?.email||''"></div>
        </div>
        <button @click="logout()" class="text-blue-300 hover:text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 ml-64">

    <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
    <template x-if="page==='dashboard'">
    <div class="p-8 fade-in">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
          <p class="text-gray-500 text-sm mt-1">Your loan case pipeline at a glance</p>
        </div>
        <button @click="page='newcase'" class="px-5 py-2.5 bg-brand-600 text-white rounded-xl font-semibold text-sm hover:bg-brand-700 transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          New Case
        </button>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
          <div class="text-2xl font-bold text-gray-900" x-text="cases.length">0</div>
          <div class="text-xs text-gray-500 mt-1">Total Cases</div>
        </div>
        <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
          <div class="text-2xl font-bold text-emerald-600" x-text="cases.filter(c=>c.status==='report_generated').length">0</div>
          <div class="text-xs text-gray-500 mt-1">Reports Ready</div>
        </div>
        <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
          <div class="text-2xl font-bold text-amber-600" x-text="cases.filter(c=>c.status==='processing'||c.status==='created').length">0</div>
          <div class="text-xs text-gray-500 mt-1">In Progress</div>
        </div>
        <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
          <div class="text-2xl font-bold text-brand-600" x-text="cases.length?Math.round(cases.reduce((a,c)=>a+c.completeness_score,0)/cases.length)+'%':'‚Äî'"></div>
          <div class="text-xs text-gray-500 mt-1">Avg Completeness</div>
        </div>
      </div>

      <!-- Case List -->
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
          <h2 class="font-semibold text-gray-900">Recent Cases</h2>
        </div>
        <template x-if="cases.length===0">
          <div class="p-12 text-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <h3 class="font-semibold text-gray-700 mb-1">No cases yet</h3>
            <p class="text-gray-500 text-sm mb-4">Create your first case to get started</p>
            <button @click="page='newcase'" class="px-5 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700">Create First Case</button>
          </div>
        </template>
        <template x-for="c in cases" :key="c.case_id">
          <div @click="openCase(c.case_id)" class="flex items-center gap-4 px-6 py-4 border-b border-gray-50 hover:bg-gray-50 cursor-pointer transition-colors">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-sm font-bold"
                 :class="{'bg-emerald-100 text-emerald-700':c.status==='report_generated','bg-blue-100 text-blue-700':c.status==='eligibility_scored','bg-amber-100 text-amber-700':c.status==='processing'||c.status==='created','bg-purple-100 text-purple-700':c.status==='features_extracted','bg-red-100 text-red-700':c.status==='failed'}"
                 x-text="(c.borrower_name||'?').charAt(0).toUpperCase()"></div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-gray-900 text-sm" x-text="c.borrower_name||c.case_id"></div>
              <div class="text-xs text-gray-500" x-text="c.case_id+' ¬∑ '+new Date(c.created_at).toLocaleDateString('en-IN')"></div>
            </div>
            <div class="text-right">
              <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-[11px] font-medium"
                    :class="{'bg-emerald-100 text-emerald-700':c.status==='report_generated','bg-blue-100 text-blue-700':c.status==='eligibility_scored','bg-amber-100 text-amber-700':c.status==='processing'||c.status==='created','bg-purple-100 text-purple-700':c.status==='features_extracted'||c.status==='documents_classified','bg-red-100 text-red-700':c.status==='failed'}">
                <span class="w-1.5 h-1.5 rounded-full pulse-dot" :class="{'bg-emerald-500':c.status==='report_generated','bg-blue-500':c.status==='eligibility_scored','bg-amber-500':c.status==='processing'||c.status==='created','bg-purple-500':c.status==='features_extracted'||c.status==='documents_classified','bg-red-500':c.status==='failed'}"></span>
                <span x-text="c.status.replace(/_/g,' ')"></span>
              </span>
              <div class="text-xs text-gray-400 mt-1" x-text="Math.round(c.completeness_score)+'% complete'"></div>
            </div>
          </div>
        </template>
      </div>
    </div>
    </template>

    <!-- ‚ïê‚ïê‚ïê NEW CASE ‚ïê‚ïê‚ïê -->
    <template x-if="page==='newcase'">
    <div class="p-8 max-w-3xl mx-auto fade-in">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Create New Case</h1>
      <p class="text-gray-500 text-sm mb-8">Enter borrower details and upload documents to get started</p>

      <!-- Step Indicator -->
      <div class="flex items-center gap-2 mb-8">
        <template x-for="(s,i) in ['Upload Documents','Borrower Info','Processing']" :key="i">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold"
                 :class="newCaseStep>i?'bg-emerald-500 text-white':newCaseStep===i?'bg-brand-600 text-white':'bg-gray-200 text-gray-500'"
                 x-text="newCaseStep>i?'‚úì':(i+1)"></div>
            <span class="text-sm font-medium" :class="newCaseStep===i?'text-brand-700':'text-gray-400'" x-text="s"></span>
            <template x-if="i<2"><div class="w-12 h-0.5" :class="newCaseStep>i?'bg-emerald-400':'bg-gray-200'"></div></template>
          </div>
        </template>
      </div>

      <!-- Step 0: Upload Documents First -->
      <template x-if="newCaseStep===0">
      <div class="fade-in space-y-4">
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
          <div class="flex items-start gap-2">
            <span class="text-blue-600 text-xl">‚ú®</span>
            <div>
              <h3 class="font-semibold text-blue-900 text-sm">Smart Workflow</h3>
              <p class="text-xs text-blue-700 mt-1">Upload documents first and we'll auto-fill borrower details from GST, PAN, and bank statements!</p>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-brand-400 transition-colors"
               @dragover.prevent="$el.classList.add('border-brand-500','bg-brand-50')"
               @dragleave.prevent="$el.classList.remove('border-brand-500','bg-brand-50')"
               @drop.prevent="handleDropForNewCase($event)">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
            <p class="font-semibold text-gray-700">Drag & drop borrower documents here</p>
            <p class="text-sm text-gray-500 mt-1">PDF, JPG, PNG, ZIP ‚Äî up to 25MB per file</p>
            <label class="mt-4 inline-block px-5 py-2.5 bg-brand-600 text-white font-medium rounded-lg cursor-pointer hover:bg-brand-700 transition-colors">
              Browse Files
              <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.tiff,.zip" class="hidden" @change="uploadInitialDocs($event)">
            </label>
          </div>
        </div>
        <template x-if="uploadedDocs.length>0">
          <div class="bg-white rounded-xl border p-4">
            <h4 class="font-semibold text-gray-800 mb-2">Uploaded Files</h4>
            <div class="space-y-1">
              <template x-for="d in uploadedDocs" :key="d.name">
                <div class="text-sm text-gray-600 flex items-center gap-2">
                  <span class="text-emerald-500">‚úì</span>
                  <span x-text="d.name"></span>
                </div>
              </template>
            </div>
          </div>
        </template>
        <button @click="proceedToBorrowerInfo()" :disabled="loading||uploadedDocs.length===0" class="w-full py-3 bg-brand-600 text-white font-semibold rounded-xl hover:bg-brand-700 transition-colors disabled:opacity-40">
          <span x-show="!loading">Continue to Borrower Info ‚Üí</span><span x-show="loading">Processing Documents...</span>
        </button>
      </div>
      </template>

      <!-- Step 1: Borrower Info (Auto-filled + Manual) -->
      <template x-if="newCaseStep===1">
      <div class="fade-in space-y-4">
        <template x-if="newCase.gst_extracted">
          <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
            <div class="flex items-start gap-2">
              <span class="text-emerald-600 text-xl">‚úì</span>
              <div>
                <h3 class="font-semibold text-emerald-900 text-sm">GST Data Extracted!</h3>
                <p class="text-xs text-emerald-700 mt-1">We've auto-filled some fields from your documents. Please review and complete the remaining fields.</p>
              </div>
            </div>
          </div>
        </template>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6 space-y-5">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
              Borrower Name
              <template x-if="newCase.borrower_name && newCase.borrower_name !== ''">
                <span class="text-emerald-500 text-xs">‚úì Auto-filled</span>
              </template>
            </label>
            <input x-model="newCase.borrower_name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none" placeholder="Enter borrower's full name">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                Entity Type
                <template x-if="newCase.entity_type && newCase.entity_type !== ''">
                  <span class="text-emerald-500 text-xs">‚úì Auto-filled</span>
                </template>
              </label>
              <select x-model="newCase.entity_type" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                <option value="">Select...</option>
                <option value="proprietorship">Proprietorship</option>
                <option value="partnership">Partnership</option>
                <option value="llp">LLP</option>
                <option value="pvt_ltd">Private Limited</option>
                <option value="public_ltd">Public Limited</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Loan Program <span class="text-red-500">*</span></label>
              <select x-model="newCase.program_type" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                <option value="">Select...</option>
                <option value="banking">Banking Program</option>
                <option value="income">Income Program</option>
                <option value="hybrid">Hybrid</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Industry</label>
              <input x-model="newCase.industry_type" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none" placeholder="e.g. Manufacturing, Trading">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5 flex items-center gap-2">
                Pincode
                <template x-if="newCase.pincode && newCase.pincode !== ''">
                  <span class="text-emerald-500 text-xs">‚úì Auto-filled</span>
                </template>
              </label>
              <input x-model="newCase.pincode" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none" placeholder="e.g. 400001" maxlength="6">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Loan Amount Requested (‚Çπ Lakhs) <span class="text-red-500">*</span></label>
            <input x-model="newCase.loan_amount_requested" type="number" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none" placeholder="e.g. 25">
          </div>
          <button @click="createCaseFromDocs()" :disabled="loading||!newCase.program_type||!newCase.loan_amount_requested" class="w-full py-3 bg-brand-600 text-white font-semibold rounded-xl hover:bg-brand-700 transition-colors disabled:opacity-40">
            <span x-show="!loading">Create Case & Continue ‚Üí</span><span x-show="loading">Creating Case...</span>
          </button>
        </div>
      </div>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-brand-400 transition-colors"
               @dragover.prevent="$el.classList.add('border-brand-500','bg-brand-50')"
               @dragleave.prevent="$el.classList.remove('border-brand-500','bg-brand-50')"
               @drop.prevent="handleDrop($event)">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
            <p class="font-semibold text-gray-700">Drag & drop borrower documents here</p>
            <p class="text-sm text-gray-500 mt-1">PDF, JPG, PNG, ZIP ‚Äî up to 25MB per file</p>
            <label class="inline-block mt-4 px-5 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium cursor-pointer hover:bg-brand-700">
              Browse Files
              <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.tiff,.zip" class="hidden" @change="handleFiles($event)">
            </label>
          </div>
        </div>

        <!-- Uploaded Files -->
        <template x-if="uploadedDocs.length>0">
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
          <div class="px-6 py-3 border-b border-gray-100 bg-gray-50">
            <span class="text-sm font-semibold text-gray-700" x-text="uploadedDocs.length+' document(s) uploaded'"></span>
          </div>
          <template x-for="d in uploadedDocs" :key="d.id">
            <div class="flex items-center gap-3 px-6 py-3 border-b border-gray-50">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold"
                   :class="d.doc_type!=='unknown'?'bg-emerald-100 text-emerald-700':'bg-amber-100 text-amber-700'">
                <span x-text="d.doc_type==='unknown'?'?':'‚úì'"></span>
              </div>
              <div class="flex-1">
                <div class="text-sm font-medium text-gray-800" x-text="d.original_filename"></div>
                <div class="text-xs text-gray-500" x-text="d.doc_type.replace(/_/g,' ')+' ¬∑ '+Math.round(d.classification_confidence*100)+'% confidence'"></div>
              </div>
              <span class="px-2 py-0.5 rounded-full text-[10px] font-medium" :class="d.status==='classified'?'bg-emerald-100 text-emerald-700':'bg-amber-100 text-amber-700'" x-text="d.status"></span>
            </div>
          </template>
        </div>
        </template>

        <div class="flex gap-3">
          <button @click="newCaseStep=2;runExtraction()" :disabled="uploadedDocs.length===0" class="flex-1 py-3 bg-brand-600 text-white font-semibold rounded-xl hover:bg-brand-700 transition-colors disabled:opacity-40">
            Run Analysis ‚Üí
          </button>
        </div>
      </div>
      </template>

      <!-- Step 3: Processing -->
      <template x-if="newCaseStep===2">
      <div class="fade-in space-y-4">
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
          <div class="space-y-4">
            <template x-for="step in pipelineSteps" :key="step.name">
              <div class="flex items-center gap-3">
                <div class="w-6 h-6 rounded-full flex items-center justify-center"
                     :class="step.status==='done'?'bg-emerald-500 text-white':step.status==='running'?'bg-brand-500 text-white animate-pulse':'bg-gray-200'">
                  <template x-if="step.status==='done'"><span class="text-xs">‚úì</span></template>
                  <template x-if="step.status==='running'"><span class="text-xs">‚ü≥</span></template>
                </div>
                <span class="text-sm" :class="step.status==='done'?'text-gray-800 font-medium':step.status==='running'?'text-brand-700 font-semibold':'text-gray-400'" x-text="step.name"></span>
              </div>
            </template>
          </div>
        </div>

        <template x-if="pipelineDone">
          <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-5 text-center fade-in">
            <div class="text-4xl mb-2">üéâ</div>
            <h3 class="font-bold text-emerald-800 text-lg">Analysis Complete!</h3>
            <p class="text-emerald-600 text-sm mt-1">Your case has been processed. View the full results.</p>
            <button @click="openCase(currentCaseId)" class="mt-4 px-6 py-2.5 bg-emerald-600 text-white rounded-xl font-semibold text-sm hover:bg-emerald-700">View Case Results ‚Üí</button>
          </div>
        </template>
      </div>
      </template>
    </div>
    </template>

    <!-- ‚ïê‚ïê‚ïê CASE DETAIL ‚ïê‚ïê‚ïê -->
    <template x-if="page==='casedetail'">
    <div class="p-8 fade-in">
      <div class="flex items-center gap-3 mb-6">
        <button @click="page='dashboard';loadCases()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <div>
          <h1 class="text-xl font-bold text-gray-900" x-text="currentCase?.borrower_name||currentCaseId"></h1>
          <p class="text-gray-500 text-xs" x-text="currentCaseId"></p>
        </div>
        <span class="ml-auto px-3 py-1 rounded-full text-xs font-semibold"
              :class="{'bg-emerald-100 text-emerald-700':currentCase?.status==='report_generated','bg-blue-100 text-blue-700':currentCase?.status==='eligibility_scored','bg-amber-100 text-amber-700':currentCase?.status==='processing'||currentCase?.status==='created','bg-purple-100 text-purple-700':currentCase?.status==='features_extracted'||currentCase?.status==='documents_classified'}"
              x-text="currentCase?.status?.replace(/_/g,' ')"></span>
      </div>

      <!-- Tabs -->
      <div class="flex gap-1 bg-gray-100 rounded-lg p-1 mb-6">
        <template x-for="t in ['Checklist','Profile','Eligibility','Report']" :key="t">
          <button @click="caseTab=t" :class="caseTab===t?'bg-white shadow text-brand-700':'text-gray-500 hover:text-gray-700'" class="px-4 py-2 rounded-md text-sm font-medium transition-all" x-text="t"></button>
        </template>
      </div>

      <!-- Checklist Tab -->
      <template x-if="caseTab==='Checklist'">
      <div class="grid grid-cols-2 gap-6 fade-in">
        <div class="space-y-4">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-800">Document Status</h3>
              <label class="px-3 py-1.5 bg-brand-600 text-white rounded-lg text-xs font-medium cursor-pointer hover:bg-brand-700">
                + Upload More
                <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.tiff,.zip" class="hidden" @change="reuploadDocs($event)">
              </label>
            </div>
            <div class="space-y-2">
              <template x-for="d in (checklist?.available||[])" :key="d">
                <div class="flex items-center gap-2 text-sm"><span class="text-emerald-500">‚úì</span><span class="text-gray-700 capitalize" x-text="d.replace(/_/g,' ')"></span></div>
              </template>
              <template x-for="d in (checklist?.missing||[])" :key="d">
                <div class="flex items-center gap-2 text-sm"><span class="text-red-400">‚úó</span><span class="text-gray-500 capitalize" x-text="d.replace(/_/g,' ')"></span><span class="text-[10px] text-red-300 ml-1">missing</span></div>
              </template>
            </div>

            <!-- WhatsApp Request Button (when docs missing) -->
            <template x-if="checklist?.missing && checklist.missing.length > 0">
              <div class="mt-4 pt-4 border-t border-gray-200">
                <button @click="requestDocsViaWhatsApp()" class="w-full px-4 py-2.5 bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                  <span>üì±</span>
                  <span>Request Missing Docs via WhatsApp</span>
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">Send a WhatsApp message to customer requesting the missing documents</p>
              </div>
            </template>
          </div>
          <!-- Uploaded Files List -->
          <template x-if="caseDocuments.length>0">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
            <h3 class="font-semibold text-gray-800 mb-3">Uploaded Files <span class="text-xs font-normal text-gray-400" x-text="'('+caseDocuments.length+')'"></span></h3>
            <div class="space-y-2">
              <template x-for="d in caseDocuments" :key="d.id">
                <div class="flex items-center gap-2 text-sm">
                  <span :class="d.doc_type&&d.doc_type!=='unknown'?'text-emerald-500':'text-amber-500'" x-text="d.doc_type&&d.doc_type!=='unknown'?'‚úì':'?'"></span>
                  <span class="text-gray-700 flex-1 truncate" x-text="d.original_filename"></span>
                  <span class="text-[10px] px-1.5 py-0.5 rounded-full" :class="d.doc_type&&d.doc_type!=='unknown'?'bg-emerald-100 text-emerald-700':'bg-amber-100 text-amber-700'" x-text="d.doc_type?d.doc_type.replace(/_/g,' '):'unclassified'"></span>
                </div>
              </template>
            </div>
          </div>
          </template>
          <!-- Unreadable files -->
          <template x-if="(checklist?.unreadable||[]).length>0">
          <div class="bg-amber-50 rounded-xl border border-amber-200 p-4">
            <h4 class="text-xs font-semibold text-amber-700 mb-2">Unclassified Files</h4>
            <template x-for="f in checklist.unreadable" :key="f">
              <div class="text-xs text-amber-600" x-text="'‚Ä¢ '+f"></div>
            </template>
          </div>
          </template>
        </div>
        <div class="space-y-4">
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
            <h3 class="font-semibold text-gray-800 mb-3">Completeness</h3>
            <div class="text-3xl font-bold" :class="(checklist?.completeness_score||0)>=80?'text-emerald-600':(checklist?.completeness_score||0)>=40?'text-brand-600':'text-red-500'" x-text="Math.round(checklist?.completeness_score||0)+'%'"></div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
              <div class="h-2.5 rounded-full transition-all" :class="(checklist?.completeness_score||0)>=80?'bg-emerald-500':(checklist?.completeness_score||0)>=40?'bg-brand-600':'bg-red-400'" :style="'width:'+Math.round(checklist?.completeness_score||0)+'%'"></div>
            </div>
            <p class="text-xs text-gray-400 mt-2">Based on documents + manual overrides</p>
          </div>
          <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6">
            <h3 class="font-semibold text-gray-800 mb-3">Manual Overrides</h3>
            <p class="text-xs text-gray-400 mb-3">Fill missing data to boost completeness</p>
            <div class="space-y-3">
              <div><label class="text-xs text-gray-500">CIBIL Score</label><input x-model="manualData.cibil_score_manual" type="number" class="w-full mt-1 px-3 py-2 border rounded-lg text-sm" placeholder="e.g. 720"></div>
              <div><label class="text-xs text-gray-500">Business Vintage (years)</label><input x-model="manualData.business_vintage_years" type="number" step="0.5" class="w-full mt-1 px-3 py-2 border rounded-lg text-sm" placeholder="e.g. 3"></div>
              <div><label class="text-xs text-gray-500">Monthly Turnover (‚Çπ Lakhs)</label><input x-model="manualData.monthly_turnover_manual" type="number" class="w-full mt-1 px-3 py-2 border rounded-lg text-sm" placeholder="e.g. 5"></div>
              <button @click="saveManualData()" :disabled="loading" class="w-full py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 disabled:opacity-50">
                <span x-show="!loading">Save & Recalculate</span><span x-show="loading">Saving...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      </template>

      <!-- Profile Tab -->
      <template x-if="caseTab==='Profile'">
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-6 fade-in">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-gray-800">Borrower Feature Vector</h3>
          <button @click="runCaseExtraction()" :disabled="loading" class="px-4 py-2 bg-brand-600 text-white rounded-lg text-xs font-medium hover:bg-brand-700 disabled:opacity-50">
            <span x-show="!loading" x-text="features?'Re-run Extraction':'Run Extraction'"></span><span x-show="loading">Extracting...</span>
          </button>
        </div>
        <template x-if="!features && !loading">
          <div class="text-center py-8">
            <p class="text-gray-500 text-sm mb-3">Features not yet extracted from uploaded documents</p>
            <p class="text-xs text-gray-400">Documents need OCR text before extraction. Click "Run Extraction" above.</p>
          </div>
        </template>
        <template x-if="features">
          <div class="grid grid-cols-2 gap-6">
            <div><h4 class="text-xs font-semibold text-gray-400 uppercase mb-3">Identity</h4>
              <div class="space-y-2">
                <div class="flex justify-between text-sm"><span class="text-gray-500">Name</span><span class="font-medium" x-text="features.full_name||'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">PAN</span><span class="font-medium" x-text="features.pan_number||'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">DOB</span><span class="font-medium" x-text="features.dob||'‚Äî'"></span></div>
              </div>
            </div>
            <div><h4 class="text-xs font-semibold text-gray-400 uppercase mb-3">Business</h4>
              <div class="space-y-2">
                <div class="flex justify-between text-sm"><span class="text-gray-500">Entity</span><span class="font-medium" x-text="(features.entity_type||'‚Äî').replace(/_/g,' ')"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">Vintage</span><span class="font-medium" x-text="features.business_vintage_years?features.business_vintage_years+' yrs':'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">GSTIN</span><span class="font-medium" x-text="features.gstin||'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">Pincode</span><span class="font-medium" x-text="features.pincode||'‚Äî'"></span></div>
              </div>
            </div>
            <div><h4 class="text-xs font-semibold text-gray-400 uppercase mb-3">Financial</h4>
              <div class="space-y-2">
                <div class="flex justify-between text-sm"><span class="text-gray-500">Annual Turnover</span><span class="font-medium" x-text="features.annual_turnover?'‚Çπ'+features.annual_turnover+'L':'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">Avg Balance</span><span class="font-medium" x-text="features.avg_monthly_balance?'‚Çπ'+Number(features.avg_monthly_balance).toLocaleString('en-IN'):'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">Monthly Credits</span><span class="font-medium" x-text="features.monthly_credit_avg?'‚Çπ'+Number(features.monthly_credit_avg).toLocaleString('en-IN'):'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">Bounces (12m)</span><span class="font-medium" x-text="features.bounce_count_12m??'‚Äî'"></span></div>
              </div>
            </div>
            <div><h4 class="text-xs font-semibold text-gray-400 uppercase mb-3">Credit</h4>
              <div class="space-y-2">
                <div class="flex justify-between text-sm"><span class="text-gray-500">CIBIL Score</span><span class="font-bold text-lg" :class="(features.cibil_score||0)>=700?'text-emerald-600':(features.cibil_score||0)>=650?'text-amber-600':'text-red-600'" x-text="features.cibil_score||'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">Active Loans</span><span class="font-medium" x-text="features.active_loan_count??'‚Äî'"></span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-500">Overdues</span><span class="font-medium" x-text="features.overdue_count??'‚Äî'"></span></div>
              </div>
            </div>
          </div>
        </template>
      </div>
      </template>

      <!-- Eligibility Tab -->
      <template x-if="caseTab==='Eligibility'">
      <div class="fade-in space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold text-gray-800">Lender Matching</h3>
          <button @click="runEligibility()" :disabled="loading" class="px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 disabled:opacity-50">
            <span x-show="!loading">Run Eligibility Scoring</span><span x-show="loading">Scoring...</span>
          </button>
        </div>
        <template x-if="eligibility">
          <div>
            <div class="grid grid-cols-3 gap-3 mb-4">
              <div class="bg-white rounded-xl border p-4 text-center"><div class="text-2xl font-bold text-gray-900" x-text="eligibility.total_lenders_evaluated"></div><div class="text-xs text-gray-500">Evaluated</div></div>
              <div class="bg-emerald-50 rounded-xl border border-emerald-200 p-4 text-center"><div class="text-2xl font-bold text-emerald-700" x-text="eligibility.lenders_passed"></div><div class="text-xs text-emerald-600">Matched</div></div>
              <div class="bg-brand-50 rounded-xl border border-brand-200 p-4 text-center"><div class="text-2xl font-bold text-brand-700" x-text="eligibility.results?.filter(r=>r.approval_probability==='high').length||0"></div><div class="text-xs text-brand-600">High Probability</div></div>
            </div>
            <div class="bg-white rounded-xl border shadow-sm overflow-hidden">
              <table class="w-full">
                <thead class="bg-gray-50"><tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500">Rank</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500">Lender</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500">Product</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500">Score</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500">Probability</th>
                  <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500">Max Ticket</th>
                </tr></thead>
                <tbody>
                  <template x-for="r in (eligibility.results||[]).filter(r=>r.hard_filter_status==='pass')" :key="r.rank">
                    <tr class="border-t border-gray-50 hover:bg-gray-50">
                      <td class="px-4 py-3 text-sm font-bold text-gray-800" x-text="r.rank"></td>
                      <td class="px-4 py-3 text-sm font-medium text-gray-900" x-text="r.lender_name"></td>
                      <td class="px-4 py-3 text-sm text-gray-600" x-text="r.product_name"></td>
                      <td class="px-4 py-3 text-center"><span class="font-bold text-sm" x-text="Math.round(r.eligibility_score)"></span><span class="text-xs text-gray-400">/100</span></td>
                      <td class="px-4 py-3 text-center"><span class="px-2 py-0.5 rounded-full text-xs font-semibold" :class="r.approval_probability==='high'?'bg-emerald-100 text-emerald-700':r.approval_probability==='medium'?'bg-amber-100 text-amber-700':'bg-red-100 text-red-700'" x-text="r.approval_probability"></span></td>
                      <td class="px-4 py-3 text-right text-sm font-medium text-gray-700" x-text="r.expected_ticket_max?'‚Çπ'+r.expected_ticket_max+'L':'‚Äî'"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Rejection Explanations (when no lenders match or show top rejections) -->
            <template x-if="eligibility.lenders_passed === 0">
              <div class="mt-4 bg-red-50 border border-red-200 rounded-xl p-5">
                <h4 class="font-semibold text-red-800 mb-3 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                  No Lenders Match This Profile
                </h4>
                <p class="text-sm text-red-700 mb-4">The following issues are preventing lender matches:</p>

                <!-- Common rejection reasons -->
                <div class="space-y-2">
                  <template x-for="(failedResult, idx) in (eligibility.results||[]).filter(r=>r.hard_filter_status!=='pass').slice(0, 5)" :key="idx">
                    <div class="bg-white rounded-lg border border-red-100 p-3">
                      <div class="flex items-start gap-2">
                        <span class="text-red-500 mt-0.5">‚ùå</span>
                        <div class="flex-1">
                          <div class="text-sm font-medium text-gray-900" x-text="failedResult.lender_name + ' - ' + failedResult.product_name"></div>
                          <div class="text-xs text-red-600 mt-1">
                            <template x-if="failedResult.failure_reasons && failedResult.failure_reasons.length > 0">
                              <span x-text="failedResult.failure_reasons.join(', ')"></span>
                            </template>
                            <template x-if="!failedResult.failure_reasons || failedResult.failure_reasons.length === 0">
                              <span>Hard filter criteria not met</span>
                            </template>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- Dynamic Recommendations -->
                <div class="mt-4 pt-4 border-t border-red-200">
                  <h5 class="font-semibold text-red-800 text-sm mb-2">üí° Top Recommendations to Improve Eligibility:</h5>

                  <!-- Dynamic recommendations from backend -->
                  <template x-if="eligibility.dynamic_recommendations && eligibility.dynamic_recommendations.length > 0">
                    <div class="space-y-3">
                      <template x-for="(rec, idx) in eligibility.dynamic_recommendations" :key="idx">
                        <div class="bg-white border border-red-200 rounded-lg p-3">
                          <div class="flex items-start gap-2">
                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-red-600 text-white text-xs font-bold flex items-center justify-center" x-text="rec.priority_rank"></div>
                            <div class="flex-1">
                              <div class="font-semibold text-red-900 text-sm" x-text="rec.issue"></div>
                              <div class="mt-1 space-y-0.5 text-xs text-red-700">
                                <div>
                                  <span class="font-medium">Current:</span>
                                  <span x-text="rec.current"></span>
                                  <span class="mx-2">‚Üí</span>
                                  <span class="font-medium">Target:</span>
                                  <span x-text="rec.target"></span>
                                </div>
                                <div class="flex items-center gap-1 text-orange-600">
                                  <span>‚ö°</span>
                                  <span class="font-medium" x-text="rec.impact"></span>
                                </div>
                                <div class="mt-1.5 text-gray-700">
                                  <span class="font-medium">Action:</span>
                                  <span x-text="rec.action"></span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </template>

                  <!-- Fallback to static recommendations if dynamic not available -->
                  <template x-if="!eligibility.dynamic_recommendations || eligibility.dynamic_recommendations.length === 0">
                    <ul class="space-y-1.5 text-xs text-red-700">
                      <template x-if="features && features.cibil_score && features.cibil_score < 700">
                        <li>‚Ä¢ Work on improving CIBIL score (currently <span x-text="features.cibil_score"></span>)</li>
                      </template>
                      <template x-if="features && features.avg_bank_balance && features.avg_bank_balance < 50000">
                        <li>‚Ä¢ Increase average monthly bank balance (currently ‚Çπ<span x-text="(features.avg_bank_balance/100000).toFixed(2)"></span>L)</li>
                      </template>
                      <template x-if="features && features.business_vintage_years && features.business_vintage_years < 2">
                        <li>‚Ä¢ Business vintage is low (currently <span x-text="features.business_vintage_years"></span> years)</li>
                      </template>
                      <template x-if="checklist && checklist.missing && checklist.missing.length > 0">
                        <li>‚Ä¢ Complete missing documents: <span x-text="checklist.missing.join(', ')"></span></li>
                      </template>
                      <li>‚Ä¢ Consider alternative loan programs or consult with credit advisors</li>
                    </ul>
                  </template>
                </div>
              </div>
            </template>

            <!-- Top Rejections (when some lenders match but others don't) -->
            <template x-if="eligibility.lenders_passed > 0 && (eligibility.results||[]).filter(r=>r.hard_filter_status!=='pass').length > 0">
              <div class="mt-4">
                <details class="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
                  <summary class="px-4 py-3 cursor-pointer hover:bg-gray-100 font-medium text-gray-700 text-sm flex items-center justify-between">
                    <span>üîç Why some lenders didn't match (<span x-text="(eligibility.results||[]).filter(r=>r.hard_filter_status!=='pass').length"></span> rejected)</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                  </summary>
                  <div class="p-4 space-y-2 bg-white">
                    <template x-for="(failedResult, idx) in (eligibility.results||[]).filter(r=>r.hard_filter_status!=='pass').slice(0, 10)" :key="idx">
                      <div class="border-l-2 border-red-300 pl-3 py-2">
                        <div class="text-sm font-medium text-gray-800" x-text="failedResult.lender_name + ' - ' + failedResult.product_name"></div>
                        <div class="text-xs text-red-600 mt-1 space-y-0.5">
                          <template x-if="failedResult.hard_filter_details && Object.keys(failedResult.hard_filter_details).length > 0">
                            <div>
                              <template x-for="(reason, key) in failedResult.hard_filter_details" :key="key">
                                <div class="flex items-start gap-1">
                                  <span class="text-red-500">‚ùå</span>
                                  <span x-text="reason"></span>
                                </div>
                              </template>
                            </div>
                          </template>
                          <template x-if="!failedResult.hard_filter_details || Object.keys(failedResult.hard_filter_details).length === 0">
                            <span>Hard filter criteria not met</span>
                          </template>
                        </div>
                      </div>
                    </template>
                  </div>
                </details>
              </div>
            </template>

          </div>
        </template>
        <template x-if="!eligibility">
          <div class="bg-white rounded-xl border p-12 text-center">
            <p class="text-gray-500 text-sm">Click "Run Eligibility Scoring" to match this borrower against all lenders</p>
          </div>
        </template>
      </div>
      </template>

      <!-- Report Tab -->
      <template x-if="caseTab==='Report'">
      <div class="fade-in space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold text-gray-800">Case Intelligence Report</h3>
          <div class="flex gap-2">
            <button @click="generateReport()" :disabled="loading" class="px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 disabled:opacity-50">Generate Report</button>
            <button @click="downloadPDF()" x-show="report" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700">Download PDF</button>
          </div>
        </div>
        <template x-if="report">
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-5">
              <h4 class="font-semibold text-emerald-800 mb-3">üí™ Strengths</h4>
              <ul class="space-y-1.5">
                <template x-for="s in report.strengths" :key="s"><li class="text-sm text-emerald-700" x-text="'‚úì '+s"></li></template>
              </ul>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-xl p-5">
              <h4 class="font-semibold text-red-800 mb-3">‚ö† Risk Flags</h4>
              <ul class="space-y-1.5">
                <template x-for="r in report.risk_flags" :key="r"><li class="text-sm text-red-700" x-text="'‚Ä¢ '+r"></li></template>
              </ul>
              <template x-if="report.risk_flags?.length===0"><p class="text-sm text-gray-500">No major risks identified</p></template>
            </div>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-5">
            <h4 class="font-semibold text-blue-800 mb-2">üìã Submission Strategy</h4>
            <p class="text-sm text-blue-700" x-text="report.submission_strategy"></p>
          </div>
          <template x-if="report.whatsapp_summary">
          <div class="bg-white rounded-xl border p-5">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-gray-800">WhatsApp Share</h4>
              <div class="flex gap-2">
                <button @click="navigator.clipboard.writeText(report.whatsapp_summary);showToast('Copied to clipboard!','success')" class="text-xs text-gray-600 font-medium hover:underline">Copy Text</button>
                <button @click="sendReportToCustomer()" class="px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded-lg flex items-center gap-1">
                  <span>üì±</span>
                  <span>Send to Customer</span>
                </button>
              </div>
            </div>
            <pre class="text-sm text-gray-600 whitespace-pre-wrap bg-gray-50 rounded-lg p-3" x-text="report.whatsapp_summary"></pre>
          </div>
          </template>
        </div>
        </template>
        <template x-if="!report">
          <div class="bg-white rounded-xl border p-12 text-center"><p class="text-gray-500 text-sm">Generate a report to see strengths, risks, and submission strategy</p></div>
        </template>
      </div>
      </template>

    </div>
    </template>

    <!-- ‚ïê‚ïê‚ïê COPILOT ‚ïê‚ïê‚ïê -->
    <template x-if="page==='copilot'">
    <div class="h-screen flex flex-col fade-in" style="height:calc(100vh)">
      <div class="px-8 py-5 border-b border-gray-200 bg-white">
        <h1 class="text-xl font-bold text-gray-900">Lender Copilot</h1>
        <p class="text-gray-500 text-xs">Ask anything about lender policies, eligibility, pincodes</p>
      </div>
      <div class="flex-1 overflow-y-auto px-8 py-6 space-y-4" id="chatbox">
        <template x-if="chatMessages.length===0">
          <div class="text-center py-12">
            <div class="text-4xl mb-3">ü§ñ</div>
            <h3 class="font-semibold text-gray-700">Hi! I'm your Lender Copilot</h3>
            <p class="text-gray-500 text-sm mt-1 mb-6">Ask me anything about lender policies</p>
            <div class="flex flex-wrap gap-2 justify-center">
              <button @click="chatInput='Which lenders fund below 650 CIBIL?';sendChat()" class="px-3 py-1.5 bg-brand-50 text-brand-700 rounded-full text-xs font-medium hover:bg-brand-100">Low CIBIL lenders</button>
              <button @click="chatInput='Which lenders are active in pincode 400001?';sendChat()" class="px-3 py-1.5 bg-brand-50 text-brand-700 rounded-full text-xs font-medium hover:bg-brand-100">Lenders in Mumbai</button>
              <button @click="chatInput='Compare Bajaj and IIFL for business loan';sendChat()" class="px-3 py-1.5 bg-brand-50 text-brand-700 rounded-full text-xs font-medium hover:bg-brand-100">Compare Bajaj vs IIFL</button>
              <button @click="chatInput='Which lender has minimum 1 year vintage?';sendChat()" class="px-3 py-1.5 bg-brand-50 text-brand-700 rounded-full text-xs font-medium hover:bg-brand-100">1yr vintage lenders</button>
              <button @click="chatInput='Which lenders do not require video KYC?';sendChat()" class="px-3 py-1.5 bg-brand-50 text-brand-700 rounded-full text-xs font-medium hover:bg-brand-100">No Video KYC</button>
            </div>
          </div>
        </template>
        <template x-for="(m,i) in chatMessages" :key="i">
          <div :class="m.role==='user'?'flex justify-end':'flex justify-start'">
            <div :class="m.role==='user'?'bg-brand-600 text-white max-w-lg':'bg-white border border-gray-200 text-gray-800 max-w-2xl'" class="px-4 py-3 rounded-2xl text-sm whitespace-pre-wrap shadow-sm" x-text="m.content"></div>
          </div>
        </template>
        <div x-show="chatLoading" class="flex justify-start"><div class="bg-gray-100 px-4 py-3 rounded-2xl text-sm text-gray-500 animate-pulse">Thinking...</div></div>
      </div>
      <div class="px-8 py-4 border-t border-gray-200 bg-white">
        <div class="flex gap-2">
          <input x-model="chatInput" @keyup.enter="sendChat()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none text-sm" placeholder="Ask about lender policies, pincodes, CIBIL requirements...">
          <button @click="sendChat()" :disabled="!chatInput.trim()||chatLoading" class="px-5 py-3 bg-brand-600 text-white rounded-xl font-medium text-sm hover:bg-brand-700 disabled:opacity-50">Send</button>
        </div>
      </div>
    </div>
    </template>

    <!-- ========================================== Bank Statement Analyzer Page ========================================== -->
    <template x-if="page==='bankanalyzer'">
    <div class="h-screen flex flex-col fade-in" style="height:calc(100vh)">
      <div class="px-8 py-5 border-b border-gray-200 bg-white">
        <h1 class="text-xl font-bold text-gray-900">Bank Statement Parsing Portal</h1>
        <p class="text-gray-500 text-sm">Upload PDFs or ZIP files. We process statements server-side and return downloadable results.</p>
      </div>

      <div class="flex-1 overflow-y-auto px-8 py-8">
        <div class="max-w-3xl mx-auto">

          <!-- Upload Area -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 mb-6">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-brand-500 transition-colors">
              <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>

              <div class="mb-4">
                <label for="bankAnalyzerFileInput" class="cursor-pointer inline-block px-6 py-3 bg-brand-600 text-white rounded-lg font-medium hover:bg-brand-700 transition-colors">
                  Choose files
                </label>
                <input
                  type="file"
                  id="bankAnalyzerFileInput"
                  @change="handleBankAnalyzerFiles($event)"
                  multiple
                  accept=".pdf,.zip"
                  class="hidden"
                />
              </div>

              <p class="text-sm text-gray-600 mb-2">
                <template x-if="bankAnalyzerFiles.length === 0">
                  <span>No files selected</span>
                </template>
                <template x-if="bankAnalyzerFiles.length > 0">
                  <span class="font-semibold text-brand-600" x-text="`${bankAnalyzerFiles.length} file(s) selected`"></span>
                </template>
              </p>

              <p class="text-xs text-gray-500">
                Accepted: one/multiple PDFs, and ZIP containing multiple PDFs
              </p>

              <!-- File List -->
              <template x-if="bankAnalyzerFiles.length > 0">
                <div class="mt-4 text-left">
                  <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                    <template x-for="(file, idx) in bankAnalyzerFiles" :key="idx">
                      <div class="flex items-center gap-2 text-sm text-gray-700">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span x-text="file.name"></span>
                        <span class="text-xs text-gray-500" x-text="`(${(file.size / 1024 / 1024).toFixed(2)} MB)`"></span>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 mt-6">
              <button
                @click="startBankStatementProcessing()"
                :disabled="bankAnalyzerFiles.length === 0 || bankAnalyzerProcessing"
                class="flex-1 px-6 py-3 bg-brand-600 text-white rounded-lg font-medium hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2"
              >
                <template x-if="!bankAnalyzerProcessing">
                  <span>Start Processing</span>
                </template>
                <template x-if="bankAnalyzerProcessing">
                  <span>Processing...</span>
                </template>
                <svg x-show="bankAnalyzerProcessing" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>

              <button
                @click="resetBankAnalyzer()"
                :disabled="bankAnalyzerProcessing"
                class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
              >
                Reset
              </button>
            </div>
          </div>

          <!-- Status Area -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Status</h3>

            <!-- Idle State -->
            <template x-if="bankAnalyzerStatus === 'idle'">
              <div class="text-center py-8">
                <div class="text-4xl mb-3">‚è≥</div>
                <p class="text-gray-600 font-medium">
                  <template x-if="bankAnalyzerFiles.length === 0">
                    <span>Waiting for upload</span>
                  </template>
                  <template x-if="bankAnalyzerFiles.length > 0">
                    <span>Ready to process</span>
                  </template>
                </p>
                <p class="text-sm text-gray-500 mt-1">
                  <template x-if="bankAnalyzerFiles.length === 0">
                    <span>No active job</span>
                  </template>
                  <template x-if="bankAnalyzerFiles.length > 0">
                    <span>Click "Start Processing" to begin</span>
                  </template>
                </p>
              </div>
            </template>

            <!-- Uploading State -->
            <template x-if="bankAnalyzerStatus === 'uploading'">
              <div class="text-center py-8">
                <div class="text-4xl mb-3 animate-pulse">üì§</div>
                <p class="text-brand-600 font-medium">Uploading files...</p>
                <p class="text-sm text-gray-500 mt-1">Please wait while we upload your documents</p>
              </div>
            </template>

            <!-- Processing State -->
            <template x-if="bankAnalyzerStatus === 'processing'">
              <div class="text-center py-8">
                <div class="text-4xl mb-3 animate-pulse">‚öôÔ∏è</div>
                <p class="text-brand-600 font-medium">Processing bank statements...</p>
                <p class="text-sm text-gray-500 mt-1">This may take a few minutes</p>
                <div class="mt-4">
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-brand-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                  </div>
                </div>
              </div>
            </template>

            <!-- Completed State -->
            <template x-if="bankAnalyzerStatus === 'completed'">
              <div class="text-center py-8">
                <div class="text-4xl mb-3">‚úÖ</div>
                <p class="text-green-600 font-medium mb-4">Processing complete!</p>
                <button
                  @click="downloadBankStatementExcel()"
                  class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-all"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  Download Excel Results
                </button>
              </div>
            </template>

            <!-- Error State -->
            <template x-if="bankAnalyzerStatus === 'error'">
              <div class="text-center py-8">
                <div class="text-4xl mb-3">‚ùå</div>
                <p class="text-red-600 font-medium mb-2">Processing failed</p>
                <p class="text-sm text-gray-600" x-text="bankAnalyzerErrorMsg || 'An error occurred'"></p>
                <button
                  @click="resetBankAnalyzer()"
                  class="mt-4 px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-all"
                >
                  Try Again
                </button>
              </div>
            </template>
          </div>

        </div>
      </div>
    </div>
    </template>

  </main>
</div>
</template>

<script>
const API = '/api/v1';

function app() {
  return {
    // Auth
    token: localStorage.getItem('token'),
    user: JSON.parse(localStorage.getItem('user')||'null'),
    authMode: 'login',
    login: { email: '', password: '' },
    reg: { full_name: '', email: '', phone: '', password: '' },
    loading: false,
    toast: { show: false, msg: '', type: 'success' },

    // Navigation
    page: 'dashboard',
    caseTab: 'Checklist',

    // Dashboard
    cases: [],

    // New Case
    newCaseStep: 0,
    newCase: { borrower_name:'', entity_type:'', program_type:'', industry_type:'', pincode:'', loan_amount_requested:null, gst_extracted: false },
    currentCaseId: null,
    uploadedDocs: [],
    pipelineSteps: [
      { name:'Extracting text (OCR)', status:'pending' },
      { name:'Classifying documents', status:'pending' },
      { name:'Extracting borrower data', status:'pending' },
      { name:'Building feature vector', status:'pending' },
    ],
    pipelineDone: false,

    // Case Detail
    currentCase: null,
    checklist: null,
    features: null,
    eligibility: null,
    report: null,
    caseDocuments: [],
    manualData: { cibil_score_manual:null, business_vintage_years:null, monthly_turnover_manual:null },

    // Copilot
    chatMessages: [],
    chatInput: '',
    chatLoading: false,

    // WhatsApp
    whatsappLinked: false,
    showWhatsAppQRModal: false,
    whatsappQRCode: '',
    whatsappSessionId: '',
    customerPhone: '',
    showSendWhatsAppModal: false,
    whatsappMessage: '',

    // Bank Statement Analyzer
    bankAnalyzerFiles: [],
    bankAnalyzerProcessing: false,
    bankAnalyzerJobId: null,
    bankAnalyzerStatus: 'idle',  // 'idle', 'uploading', 'processing', 'completed', 'error'
    bankAnalyzerDownloadUrl: null,
    bankAnalyzerErrorMsg: '',

    async init() {
      if (this.token) { await this.loadCases(); }
    },

    showToast(msg, type='success') {
      this.toast = { show:true, msg, type };
      setTimeout(() => this.toast.show = false, 3000);
    },

    headers() {
      return { 'Authorization': 'Bearer '+this.token, 'Content-Type': 'application/json' };
    },

    async api(method, path, body=null) {
      const opts = { method, headers: this.headers() };
      if (body && !(body instanceof FormData)) opts.body = JSON.stringify(body);
      if (body instanceof FormData) { opts.body = body; delete opts.headers['Content-Type']; }
      const res = await fetch(API+path, opts);
      if (res.status === 401) { this.logout(); return null; }
      if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.detail || 'Request failed'); }
      return res.json();
    },

    // ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
    async doRegister() {
      this.loading = true;
      try {
        const regRes = await fetch(API+'/auth/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(this.reg) });
        if (!regRes.ok) { const err = await regRes.json().catch(()=>({})); throw new Error(err.detail || 'Registration failed'); }
        this.showToast('Account created! Signing you in...');
        // Auto-login after successful registration
        this.login.email = this.reg.email;
        this.login.password = this.reg.password;
        await this.doLogin();
        return;
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
    },

    async doLogin() {
      this.loading = true;
      try {
        const res = await fetch(API+'/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: this.login.email, password: this.login.password }) });
        if (!res.ok) throw new Error('Invalid credentials');
        const data = await res.json();
        this.token = data.access_token;
        localStorage.setItem('token', this.token);
        // Get user info
        const userRes = await fetch(API+'/auth/me', { headers:{'Authorization':'Bearer '+this.token} });
        if (userRes.ok) { this.user = await userRes.json(); localStorage.setItem('user', JSON.stringify(this.user)); }
        await this.loadCases();
        this.showToast('Welcome back!');
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
    },

    logout() {
      this.token = null; this.user = null;
      localStorage.removeItem('token'); localStorage.removeItem('user');
    },

    // ‚îÄ‚îÄ‚îÄ Cases ‚îÄ‚îÄ‚îÄ
    async loadCases() {
      try { this.cases = await this.api('GET', '/cases/') || []; } catch(e) { this.cases = []; }
    },

    async createCase() {
      this.loading = true;
      try {
        const data = {};
        for (const [k,v] of Object.entries(this.newCase)) { if(v) data[k] = v; }
        const c = await this.api('POST', '/cases/', data);
        this.currentCaseId = c.case_id;
        this.currentCase = c;
        this.newCaseStep = 1;
        this.showToast('Case '+c.case_id+' created!');
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
    },

    async handleFiles(event) {
      const files = event.target.files;
      await this.uploadFiles(files);
    },

    async handleDrop(event) {
      const files = event.dataTransfer.files;
      await this.uploadFiles(files);
    },

    async uploadFiles(files) {
      this.loading = true;
      try {
        const fd = new FormData();
        for (const f of files) fd.append('files', f);
        const docs = await this.api('POST', '/cases/'+this.currentCaseId+'/upload', fd);
        this.uploadedDocs = docs;
        this.showToast(docs.length+' document(s) uploaded & classified');
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
    },

    async runExtraction() {
      for (let i=0; i<this.pipelineSteps.length; i++) {
        this.pipelineSteps[i].status = 'running';
        try {
          if (i === 0 || i === 1) await new Promise(r => setTimeout(r, 800)); // OCR & classify already done during upload
          if (i === 2) await this.api('POST', '/extraction/case/'+this.currentCaseId+'/extract');
          if (i === 3) await this.api('GET', '/extraction/case/'+this.currentCaseId+'/features');
        } catch(e) { /* continue */ }
        this.pipelineSteps[i].status = 'done';
      }
      this.pipelineDone = true;
    },

    async uploadInitialDocs(event) {
      const files = event.target.files;
      this.uploadedDocs = Array.from(files);
    },

    async handleDropForNewCase(event) {
      const files = event.dataTransfer.files;
      this.uploadedDocs = Array.from(files);
    },

    async proceedToBorrowerInfo() {
      // Create minimal case first to get case_id
      this.loading = true;
      try {
        const minimalData = {
          borrower_name: 'Pending Upload',
          entity_type: 'proprietorship',
          program_type: 'banking'
        };
        const c = await this.api('POST', '/cases/', minimalData);
        this.currentCaseId = c.case_id;
        this.currentCase = c;

        // Upload documents
        const fd = new FormData();
        for (const f of this.uploadedDocs) fd.append('files', f);
        await this.api('POST', '/cases/'+this.currentCaseId+'/upload', fd);

        // Try to extract GST data
        try {
          const gstRes = await this.api('GET', '/cases/'+this.currentCaseId+'/gst-data');
          if (gstRes.gst_data) {
            // Auto-fill from GST data
            if (gstRes.gst_data.borrower_name) this.newCase.borrower_name = gstRes.gst_data.borrower_name;
            if (gstRes.gst_data.entity_type) this.newCase.entity_type = gstRes.gst_data.entity_type;
            if (gstRes.gst_data.pincode) this.newCase.pincode = gstRes.gst_data.pincode;
            this.newCase.gst_extracted = true;
          }
        } catch (e) {
          // GST extraction failed, user will fill manually
          this.newCase.gst_extracted = false;
        }

        // Move to next step
        this.newCaseStep = 1;
      } catch(e) {
        this.showToast('Failed to process documents: ' + e.message, 'error');
      }
      this.loading = false;
    },

    async createCaseFromDocs() {
      // Update case with final borrower info
      this.loading = true;
      try {
        const updateData = {};
        for (const [k,v] of Object.entries(this.newCase)) {
          if(v && k !== 'gst_extracted') updateData[k] = v;
        }
        await this.api('PATCH', '/cases/'+this.currentCaseId, updateData);

        // Move to processing step
        this.newCaseStep = 2;
        this.showToast('Case created successfully!');

        // Run extraction pipeline
        await this.runExtraction();
      } catch(e) {
        this.showToast('Failed to create case: ' + e.message, 'error');
      }
      this.loading = false;
    },

    async openCase(caseId) {
      this.currentCaseId = caseId;
      this.page = 'casedetail';
      this.caseTab = 'Checklist';
      this.checklist = null; this.features = null; this.eligibility = null; this.report = null; this.caseDocuments = [];
      try {
        this.currentCase = await this.api('GET', '/cases/'+caseId);
        // Pre-fill manual data from case
        this.manualData = {
          cibil_score_manual: this.currentCase?.cibil_score_manual || null,
          business_vintage_years: this.currentCase?.business_vintage_years || null,
          monthly_turnover_manual: this.currentCase?.monthly_turnover_manual || null
        };
      } catch(e) {}
      try { this.checklist = await this.api('GET', '/cases/'+caseId+'/checklist'); } catch(e) {}
      try { this.loadCaseDocuments(); } catch(e) {}
      try { this.features = await this.api('GET', '/extraction/case/'+caseId+'/features'); } catch(e) {}
      try { this.eligibility = await this.api('GET', '/eligibility/case/'+caseId+'/results'); } catch(e) {}
    },

    async loadCaseDocuments() {
      try {
        this.caseDocuments = await this.api('GET', '/cases/'+this.currentCaseId+'/documents') || [];
      } catch(e) { this.caseDocuments = []; }
    },

    async reuploadDocs(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      this.loading = true;
      try {
        const fd = new FormData();
        for (const f of files) fd.append('files', f);
        const docs = await this.api('POST', '/cases/'+this.currentCaseId+'/upload', fd);
        this.showToast(docs.length+' document(s) uploaded!');
        // Refresh checklist and case data
        try { this.checklist = await this.api('GET', '/cases/'+this.currentCaseId+'/checklist'); } catch(e) {}
        try { this.currentCase = await this.api('GET', '/cases/'+this.currentCaseId); } catch(e) {}
        try { this.loadCaseDocuments(); } catch(e) {}
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
      event.target.value = '';  // Reset file input
    },

    async saveManualData() {
      this.loading = true;
      try {
        const data = {};
        for (const [k,v] of Object.entries(this.manualData)) { if(v !== null && v !== '' && v !== undefined) data[k] = Number(v); }
        if (Object.keys(data).length === 0) { this.showToast('Please enter at least one value','error'); this.loading = false; return; }
        await this.api('PATCH', '/cases/'+this.currentCaseId, data);
        // Refresh checklist and case to see updated completeness
        this.checklist = await this.api('GET', '/cases/'+this.currentCaseId+'/checklist');
        this.currentCase = await this.api('GET', '/cases/'+this.currentCaseId);
        this.showToast('Manual data saved ‚Äî completeness recalculated!');
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
    },

    async runCaseExtraction() {
      this.loading = true;
      try {
        const result = await this.api('POST', '/extraction/case/'+this.currentCaseId+'/extract');
        this.showToast('Extraction complete ‚Äî '+result.total_fields_extracted+' fields extracted');
        // Load the feature vector
        try { this.features = await this.api('GET', '/extraction/case/'+this.currentCaseId+'/features'); } catch(e) {}
        // Refresh case status
        try { this.currentCase = await this.api('GET', '/cases/'+this.currentCaseId); } catch(e) {}
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
    },

    async runEligibility() {
      this.loading = true;
      try {
        this.eligibility = await this.api('POST', '/eligibility/case/'+this.currentCaseId+'/score');
        this.showToast('Scoring complete ‚Äî '+this.eligibility.lenders_passed+' lenders matched!');
        // Refresh case status
        try { this.currentCase = await this.api('GET', '/cases/'+this.currentCaseId); } catch(e) {}
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
    },

    async generateReport() {
      this.loading = true;
      try {
        const genResult = await this.api('POST', '/reports/case/'+this.currentCaseId+'/generate');
        this.showToast('Report generated!');
        // Now fetch the actual report data
        try {
          this.report = await this.api('GET', '/reports/case/'+this.currentCaseId+'/report');
          // Also get WhatsApp summary
          try {
            const waRes = await fetch(API+'/reports/case/'+this.currentCaseId+'/report/whatsapp', { headers:{'Authorization':'Bearer '+this.token} });
            if (waRes.ok) { this.report.whatsapp_summary = await waRes.text(); }
          } catch(e) {}
        } catch(e) { this.report = genResult; }
        // Refresh case status
        try { this.currentCase = await this.api('GET', '/cases/'+this.currentCaseId); } catch(e) {}
      } catch(e) { this.showToast(e.message,'error'); }
      this.loading = false;
    },

    async downloadPDF() {
      window.open(API+'/reports/case/'+this.currentCaseId+'/report/pdf', '_blank');
    },

    // ‚îÄ‚îÄ‚îÄ Copilot ‚îÄ‚îÄ‚îÄ
    async sendChat() {
      if (!this.chatInput.trim()) return;
      const q = this.chatInput;
      this.chatMessages.push({ role:'user', content:q });
      this.chatInput = '';
      this.chatLoading = true;
      this.$nextTick(() => { document.getElementById('chatbox').scrollTop = 99999; });
      try {
        const res = await this.api('POST', '/copilot/query', { query: q });
        this.chatMessages.push({ role:'assistant', content: res.answer });
      } catch(e) {
        this.chatMessages.push({ role:'assistant', content: 'Sorry, I encountered an error. Please try again.' });
      }
      this.chatLoading = false;
      this.$nextTick(() => { document.getElementById('chatbox').scrollTop = 99999; });
    },

    async sendReportToCustomer() {
      // Check if WhatsApp linked
      if (!this.whatsappLinked || !this.whatsappSessionId) {
        // Show QR modal to link WhatsApp
        this.showWhatsAppQRModal = true;
        await this.generateWhatsAppQR();
        return;
      }

      // Verify session is still valid before opening send modal
      try {
        const sessionCheck = await this.api('GET', `/whatsapp/session/${this.whatsappSessionId}`);
        const linkedNumber = sessionCheck.linkedNumber || sessionCheck.linked_number;

        if (sessionCheck.status === 'ready' && linkedNumber) {
          // Session is valid - update customer phone and show send modal
          this.customerPhone = linkedNumber;
          this.draftWhatsAppMessage();
          this.showSendWhatsAppModal = true;
        } else {
          // Session expired or invalid - re-link
          this.showToast('WhatsApp session expired. Please re-link.', 'error');
          this.whatsappLinked = false;
          this.whatsappSessionId = '';
          this.customerPhone = '';
          this.whatsappQRCode = '';

          // Show QR modal to re-link
          setTimeout(() => {
            this.showWhatsAppQRModal = true;
            this.generateWhatsAppQR();
          }, 500);
        }
      } catch (e) {
        // Error checking session - assume expired and re-link
        this.showToast('WhatsApp session check failed. Please re-link.', 'error');
        this.whatsappLinked = false;
        this.whatsappSessionId = '';
        this.customerPhone = '';
        this.whatsappQRCode = '';

        setTimeout(() => {
          this.showWhatsAppQRModal = true;
          this.generateWhatsAppQR();
        }, 500);
      }
    },

    async sendWhatsAppMessage() {
      // Validate inputs
      if (!this.customerPhone) {
        this.showToast('Please enter customer WhatsApp number', 'error');
        return;
      }
      if (!this.whatsappMessage) {
        this.showToast('Please enter a message', 'error');
        return;
      }

      try {
        this.loading = true;
        // Remove + sign from phone number if present (WhatsApp expects format without +)
        const phoneNumber = this.customerPhone.replace(/^\+/, '');

        const response = await this.api('POST', '/whatsapp/send-message', {
          case_id: this.currentCaseId,
          to: phoneNumber,
          message: this.whatsappMessage
        });

        // Check if WhatsApp service actually sent the message
        if (response.success) {
          this.showToast('Message sent successfully via WhatsApp!', 'success');
          this.showSendWhatsAppModal = false;
        } else {
          const errorMsg = response.error || 'Unknown error';

          // Check if session expired/not found
          if (errorMsg.toLowerCase().includes('session not found') || errorMsg.toLowerCase().includes('not found') || errorMsg.toLowerCase().includes('session')) {
            this.showToast('WhatsApp session expired. Please re-link your WhatsApp.', 'error');
            this.showSendWhatsAppModal = false;

            // Reset WhatsApp state completely
            this.whatsappLinked = false;
            this.whatsappSessionId = '';
            this.customerPhone = '';  // Clear customer phone for fresh re-link
            this.whatsappQRCode = '';  // Clear old QR code

            // Auto-open QR modal after 1 second to re-link
            setTimeout(() => {
              this.showWhatsAppQRModal = true;
              this.generateWhatsAppQR();
            }, 1000);
          } else {
            this.showToast('WhatsApp sending failed: ' + errorMsg, 'error');
          }
        }
      } catch (e) {
        this.showToast('Failed to send WhatsApp message: ' + (e.message || 'Unknown error'), 'error');
      } finally {
        this.loading = false;
      }
    },

    async generateWhatsAppQR() {
      try {
        const res = await this.api('POST', '/whatsapp/generate-qr', { case_id: this.currentCaseId });

        if (res.success) {
          this.whatsappSessionId = res.session_id || res.sessionId;

          // Check if already linked (status === 'ready')
          const linkedNumber = res.linkedNumber || res.linked_number;
          if (res.status === 'ready' && linkedNumber) {
            // Already linked! Close modal and show success
            this.whatsappLinked = true;
            this.showWhatsAppQRModal = false;
            this.customerPhone = linkedNumber;
            this.showToast(`WhatsApp linked successfully! Number: ${this.customerPhone}`, 'success');

            // Auto-open send message UI
            setTimeout(() => {
              this.showSendWhatsAppModal = true;
              this.draftWhatsAppMessage();
            }, 500);
            return;
          }

          // Not linked yet - show QR code
          this.whatsappQRCode = res.qr_code || res.qrCode;

          // Poll for linking status
          this.pollWhatsAppLink();
        } else {
          this.showToast('QR generation failed: ' + (res.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        this.showToast('Failed to generate QR code: ' + (e.message || 'Unknown error'), 'error');
      }
    },

    async pollWhatsAppLink() {
      if (!this.whatsappSessionId) {
        console.error('No session ID available for polling');
        return;
      }

      // Poll every 3 seconds to check if WhatsApp is linked
      const pollInterval = setInterval(async () => {
        try {
          const res = await this.api('GET', `/whatsapp/session/${this.whatsappSessionId}`);
          const linkedNumber = res.linkedNumber || res.linked_number;
          if (res.status === 'ready' && linkedNumber) {
            this.whatsappLinked = true;
            this.showWhatsAppQRModal = false;
            this.customerPhone = linkedNumber;
            this.showToast(`WhatsApp linked successfully! Number: ${this.customerPhone}`, 'success');
            clearInterval(pollInterval);

            // Auto-open send message UI after successful scan
            setTimeout(() => {
              this.showSendWhatsAppModal = true;
              this.draftWhatsAppMessage();
            }, 500);
          }
        } catch (e) {
          // Ignore polling errors
          console.log('Polling error:', e);
        }
      }, 3000);

      // Stop polling after 60 seconds
      setTimeout(() => clearInterval(pollInterval), 60000);
    },

    draftWhatsAppMessage() {
      // Auto-draft WhatsApp message with report summary
      if (this.report && this.report.whatsapp_summary) {
        this.whatsappMessage = this.report.whatsapp_summary;
      } else {
        // Fallback message
        this.whatsappMessage = `Hi, your loan application (Case ${this.currentCaseId}) has been processed. Please review the recommendations.`;
      }
    },

    async requestDocsViaWhatsApp() {
      // Check if WhatsApp linked
      if (!this.whatsappLinked) {
        // Show QR modal to link WhatsApp
        this.showWhatsAppQRModal = true;
        await this.generateWhatsAppQR();
        return;
      }

      // Prompt for customer phone if not available
      if (!this.customerPhone) {
        const phone = prompt('Enter customer WhatsApp number (with country code):');
        if (!phone) return;
        this.customerPhone = phone;
      }

      // Get missing documents
      const missingDocs = this.checklist && this.checklist.missing ? this.checklist.missing : [];

      if (missingDocs.length === 0) {
        this.showToast('No missing documents!', 'info');
        return;
      }

      // Build message
      const docList = missingDocs.map(doc => `‚Ä¢ ${doc}`).join('\n');
      const message = `Hi, we need the following documents for your loan application (Case: ${this.currentCase.case_id}):\n\n${docList}\n\nPlease share these documents via WhatsApp.\n\nThanks!`;

      try {
        this.loading = true;
        await this.api('POST', '/whatsapp/send-message', {
          sessionId: this.whatsappSessionId,
          to: this.customerPhone,
          message: message
        });
        this.showToast('Document request sent to customer via WhatsApp!', 'success');
      } catch (e) {
        this.showToast('Failed to send WhatsApp message: ' + (e.message || 'Unknown error'), 'error');
      } finally {
        this.loading = false;
      }
    },

    // ‚îÄ‚îÄ‚îÄ Bank Statement Analyzer ‚îÄ‚îÄ‚îÄ
    handleBankAnalyzerFiles(event) {
      const files = Array.from(event.target.files);
      this.bankAnalyzerFiles = files;
      this.bankAnalyzerStatus = 'idle';
      this.bankAnalyzerDownloadUrl = null;
      this.bankAnalyzerErrorMsg = '';
    },

    async startBankStatementProcessing() {
      if (this.bankAnalyzerFiles.length === 0) {
        this.showToast('Please select at least one file', 'error');
        return;
      }

      try {
        this.bankAnalyzerStatus = 'uploading';
        this.bankAnalyzerProcessing = true;
        this.bankAnalyzerErrorMsg = '';

        // Create FormData
        const formData = new FormData();
        this.bankAnalyzerFiles.forEach(file => {
          formData.append('files', file);
        });

        // Upload to backend proxy (which forwards to external API)
        const response = await fetch(API + '/bank-statement/process', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + this.token
          },
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `Upload failed: ${response.statusText}`);
        }

        this.bankAnalyzerStatus = 'processing';
        this.showToast('Files uploaded successfully! Processing...', 'success');

        // Check if response is Excel file (for immediate download)
        const contentType = response.headers.get('content-type');
        if (contentType && (contentType.includes('spreadsheet') || contentType.includes('excel') || contentType.includes('vnd'))) {
          // Direct Excel response
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          this.bankAnalyzerDownloadUrl = url;
          this.bankAnalyzerStatus = 'completed';
          this.showToast('Processing complete! Excel file ready for download.', 'success');
        } else {
          // JSON response with job ID (if API uses async processing)
          const result = await response.json();
          if (result.downloadUrl || result.download_url) {
            this.bankAnalyzerDownloadUrl = result.downloadUrl || result.download_url;
            this.bankAnalyzerStatus = 'completed';
            this.showToast('Processing complete! Click to download Excel.', 'success');
          } else if (result.jobId || result.job_id) {
            this.bankAnalyzerJobId = result.jobId || result.job_id;
            this.pollBankAnalyzerJob();
          } else {
            throw new Error('Unexpected response format');
          }
        }
      } catch (e) {
        this.bankAnalyzerStatus = 'error';
        this.bankAnalyzerErrorMsg = e.message || 'Processing failed';
        this.showToast('Error: ' + this.bankAnalyzerErrorMsg, 'error');
      } finally {
        this.bankAnalyzerProcessing = false;
      }
    },

    async pollBankAnalyzerJob() {
      // Poll for job completion (if API uses async processing)
      const maxAttempts = 60; // 5 minutes (5s interval)
      let attempts = 0;

      const pollInterval = setInterval(async () => {
        attempts++;
        if (attempts > maxAttempts) {
          clearInterval(pollInterval);
          this.bankAnalyzerStatus = 'error';
          this.bankAnalyzerErrorMsg = 'Processing timeout';
          this.showToast('Processing timeout. Please try again.', 'error');
          return;
        }

        try {
          const response = await fetch(`https://skill-deploy-wudy4wwji7-codex-agent-deploys.vercel.app/api/job/${this.bankAnalyzerJobId}`);
          const result = await response.json();

          if (result.status === 'completed' && result.downloadUrl) {
            clearInterval(pollInterval);
            this.bankAnalyzerDownloadUrl = result.downloadUrl;
            this.bankAnalyzerStatus = 'completed';
            this.showToast('Processing complete! Click to download Excel.', 'success');
          } else if (result.status === 'error') {
            clearInterval(pollInterval);
            this.bankAnalyzerStatus = 'error';
            this.bankAnalyzerErrorMsg = result.error || 'Processing failed';
            this.showToast('Error: ' + this.bankAnalyzerErrorMsg, 'error');
          }
        } catch (e) {
          // Continue polling on error
          console.log('Polling error:', e);
        }
      }, 5000);
    },

    downloadBankStatementExcel() {
      if (!this.bankAnalyzerDownloadUrl) return;

      const link = document.createElement('a');
      link.href = this.bankAnalyzerDownloadUrl;
      link.download = `bank_statement_analysis_${Date.now()}.xlsx`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      this.showToast('Download started!', 'success');
    },

    resetBankAnalyzer() {
      this.bankAnalyzerFiles = [];
      this.bankAnalyzerProcessing = false;
      this.bankAnalyzerJobId = null;
      this.bankAnalyzerStatus = 'idle';
      this.bankAnalyzerDownloadUrl = null;
      this.bankAnalyzerErrorMsg = '';
      // Reset file input
      const fileInput = document.getElementById('bankAnalyzerFileInput');
      if (fileInput) fileInput.value = '';
    },
  };
}
</script>

<!-- WhatsApp QR Modal -->
<div x-show="showWhatsAppQRModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;" @click.self="showWhatsAppQRModal=false">
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
    <div class="text-center">
      <h3 class="text-lg font-bold text-gray-900 mb-2">Link WhatsApp Account</h3>
      <p class="text-sm text-gray-600 mb-4">Scan this QR code with your WhatsApp mobile app to link your account</p>

      <template x-if="whatsappQRCode">
        <div class="mb-4">
          <img :src="whatsappQRCode" alt="WhatsApp QR Code" class="mx-auto border border-gray-300 rounded-lg" style="max-width:250px;"/>
        </div>
      </template>

      <template x-if="!whatsappQRCode">
        <div class="mb-4 py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
          <p class="text-sm text-gray-500 mt-3">Generating QR code...</p>
        </div>
      </template>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs text-blue-700 mb-4">
        <p class="font-medium mb-1">How to scan:</p>
        <ol class="list-decimal list-inside space-y-1 text-left">
          <li>Open WhatsApp on your phone</li>
          <li>Tap Settings ‚Üí Linked Devices</li>
          <li>Tap "Link a Device"</li>
          <li>Point your phone at this screen to scan the QR code</li>
        </ol>
      </div>

      <button @click="showWhatsAppQRModal=false" class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Send WhatsApp Message Modal -->
<div x-show="showSendWhatsAppModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;" @click.self="showSendWhatsAppModal=false">
  <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
    <div class="mb-4">
      <h3 class="text-lg font-bold text-gray-900 mb-2">üì± Send WhatsApp Message</h3>
      <p class="text-sm text-gray-600">Review and send the message to your customer</p>
    </div>

    <!-- Customer Phone Number -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Customer WhatsApp Number</label>
      <input
        type="text"
        x-model="customerPhone"
        placeholder="e.g., +919876543210"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
      />
      <p class="text-xs text-gray-500 mt-1">Include country code (e.g., +91 for India)</p>
    </div>

    <!-- Message Preview -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
      <textarea
        x-model="whatsappMessage"
        rows="8"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm font-mono"
      ></textarea>
      <p class="text-xs text-gray-500 mt-1">You can edit the message before sending</p>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3">
      <button
        @click="showSendWhatsAppModal=false"
        class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium"
      >
        Cancel
      </button>
      <button
        @click="sendWhatsAppMessage()"
        :disabled="loading"
        class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
      >
        <span x-show="!loading">Send Message</span>
        <span x-show="loading">
          <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </span>
      </button>
    </div>
  </div>
</div>

</body>
</html>
